<template>
  <div>
    <mu-card>
      <mu-table class="ttable" border="0" width="100%" :selectable="false" :showCheckbox="false">
        <mu-thead>
          <mu-tr>
            <mu-th width="15%">Customer</mu-th>
            <mu-th width="30%">Current Cart</mu-th>
            <mu-th width="30%">Recommender</mu-th>
            <mu-th width="25%">Summary</mu-th>
          </mu-tr>
        </mu-thead>
        <mu-tbody>
          <template v-for="(item,idx) in customerList2">
            <mu-tr valign="top">
              <mu-td class="thumb" style="text-align:center" v-bind:key="idx">
                <img :src="item.uploaded_image_url" style="width:100%" />
                <br />{{item.displayName}}
                <br />
                <mu-badge v-if="item.face" :content="item.face[0].faceAttributes.gender.toUpperCase() + ' - ' + item.face[0].faceAttributes.age" />
              </mu-td>
              <mu-td valign="top" v-bind:key="idx">
                <mu-auto-complete hintText="Fill-in product" :maxSearchResults="8" filter="caseInsensitiveFilter" :dataSource="dataSource" @select="handleSelect" v-model="currentText" />
                <template v-for="(obj,idx2) in selectList">
                  <br />
                  <mu-checkbox v-model="checkList" :label="obj.text" :nativeValue="obj.value" name="group" @change="handleRemove(obj.value)" />
                </template>
                <br />
                <mu-raised-button :label="recLabel" primary @click="getRecommend()" />
              </mu-td>
              <mu-td valign="top" v-bind:key="idx">
                Recommend {{recList.length}} item
                <template v-for="itemId in recList">
                  <br />
                  <mu-checkbox :label="products[itemId]" :value="itemId" />
                </template>
              </mu-td>
              <mu-td valign="bottom" v-bind:key="idx">
                <div style="font-size:1em">Discount</div>
                <div style="font-size:3em">0%</div>
                <mu-raised-button label="Buy" icon="shopping_cart" primary /> &nbsp;
                <mu-raised-button label="Void" icon="delete" secondary />
              </mu-td>
            </mu-tr>
          </template>
        </mu-tbody>
      </mu-table>
    </mu-card>
  </div>
</template>
<script>
import { mapState } from 'vuex'
import axios from 'axios'
import products from '../products.json'
export default {
  data() {
    return {
      currentText: '',
      checkList: [],
      customerList: [],
      customerList2: [],
      recList: [],
      products,
      dataSource: [],
      selectList: [],
      groupId: 'M18-24',
      recLabel: 'Get Recommend',
      allowList: [10339, 12060, 35050, 12020, 49583, 21653, 16560, 35050, 21527, 21527, 37388, 43545, 38141, 15693, 10036, 5487, 10339, 44786, 32018, 12020, 17579, 12020, 44786, 6508, 10339, 48747, 16560, 32018, 24413, 24413, 10036, 49519, 49519, 8912, 8710, 39468, 13269, 32989, 13269, 6111, 20169, 6508, 24035, 4809, 17530, 10339, 17530, 39977, 32989, 6508, 17530, 17530, 38141, 48747, 17579, 39468, 39468, 9203, 48747, 24413, 49583, 9203, 24413, 34137, 41806, 11707, 44786, 14447, 8710, 17530, 37754, 41806, 10339, 15842, 45495, 11707, 34137, 23291, 17530, 39427, 39468, 8574, 49519, 4809, 24363, 34137, 12820, 38312, 8912, 895, 23025, 24035, 48220, 37388, 5491, 32331, 14917, 17530, 35633, 29180, 37940, 30192, 31504, 5491, 38312, 7350, 8580, 49044, 17579, 39322, 49044, 37754, 45767, 22969, 2067, 37003, 43279, 21150, 26131, 10753, 10125, 36205, 14917, 41375, 35633, 47167, 4812, 10339, 15984, 11925, 11737, 14491, 11688, 23291, 37141, 7026, 10753, 48220, 14491, 37940, 38241, 4812, 36316, 4962, 22227, 5250, 10753, 264, 15984, 24035, 17630, 17630, 34993, 37940, 48726, 47029, 37141, 38241, 49044, 23025, 36205, 14211, 37003, 10753, 22227, 32331, 31231, 49519, 2716, 38985, 47888, 18176, 22969, 4962, 10768, 18606, 46817, 12745, 33929, 38192, 45210, 14211, 31288, 17553, 38985, 38544, 5491, 38544, 30192, 23025, 44156, 11123, 7533, 5250, 33791, 37947, 895, 31635, 37003, 37718, 42372, 23296, 15693, 38312, 19046, 12745, 37718, 33791, 5250, 5114, 24186, 5491, 21162, 33791, 5250, 48220, 14211, 31635, 26131, 22227, 33548, 31504, 33716, 38241, 22969, 33791, 45106, 47029, 46023, 43654, 8490, 45210, 10768, 2716, 17183, 7693, 23296, 11123, 15984, 33548, 33791, 12745, 20899, 31231, 7533, 47912, 46817, 49044, 38241, 33548, 33548, 33716, 2067, 26629, 5491, 43654, 31231, 21162, 23025, 25495, 33548, 23579, 33929, 44156, 44156, 2716, 31964, 30192, 43643, 43654, 19354, 2361, 31635, 5114, 43643, 33716, 4812, 4962, 43182, 19046, 6933, 13292, 38544, 45210, 48335, 44156, 38192, 5250, 34134, 47888, 37718, 41131, 49044, 17553, 14211, 47717, 8580, 35851, 26629, 43631, 41806, 34134, 10312, 30353, 3020, 33548, 42710, 28378, 6287, 42710, 44156, 18176, 31215, 33716, 23296, 7533, 37947, 43875, 5250, 48726, 46817, 9327, 48523, 47888, 7533, 3020, 33716, 30353, 29503, 17553, 23296, 7533, 23296, 26629, 10312, 23579, 5114, 26629, 20876, 18926, 43875, 5114, 11123, 20899, 38241, 48726, 23579, 11688, 4462, 47977, 48726, 10125, 43875, 31504, 16696, 39450, 13292, 5250, 20876, 33716, 34134, 31759, 31504, 23296, 48523, 12745, 43875, 26629, 43643, 12576, 23296, 11688, 1559, 34134, 46088, 44156, 19821, 48726, 4812, 47029, 26629, 49628, 27020, 2716, 33791, 22227, 33716, 23296, 33791, 44156, 22124, 11688, 17224, 46817, 33548, 47912, 31288, 37947, 38241, 25949, 37947, 16290, 16290, 35851, 5250, 13292, 39947, 26915, 33548, 28946, 20899, 31964, 19354, 18926, 38241, 41400, 34134, 19156, 47888, 10768, 46817, 33791, 46562, 40198, 10768, 44156, 39947, 47029, 35851, 49628, 43875, 8490, 38192, 3020, 47888, 47029, 3020, 5250, 43875, 8580, 40198, 34217, 23634, 14211, 11688, 47888, 49247, 1559, 16290, 26915, 9124, 29270, 46886, 4138, 8309, 17758, 33716, 34134, 13263, 2361, 37947, 26032, 31635, 22124, 46886, 24850, 46817, 13351, 17758, 42372, 26131, 12576, 7533, 14211, 11688, 10768, 45664, 22227, 28378, 2716, 45210, 43875, 46041, 34134, 47912, 47977, 2611, 49247, 5322, 22227, 22124, 13032, 38192, 14211, 17579, 23579, 46061, 33716, 39947, 47977, 3020, 37552, 49215, 44116, 12576, 22151, 23579, 8615, 28465, 22151, 5114, 40198, 39581, 31759, 17758, 17341, 47888, 46817, 8736, 47717, 25949, 2717, 19156, 22124, 45747, 26629, 46886, 22124, 13351, 24850, 13351, 31759, 47087, 36316, 38312, 36865, 5322, 25087, 47792, 41276, 31215, 17630, 5322, 21769, 33787, 21572, 38656, 3020, 22227, 45210, 47977, 23579, 28378, 12745, 41682, 17758, 10768, 6069, 13042, 31215, 28465, 38241, 36865, 28465, 3020, 12745, 31215, 7644, 10032, 2361, 21463, 39947, 34993, 17224, 43875, 43875, 41682, 22556, 19894, 12576, 9598, 12745, 23579, 48523, 7533, 8309, 36865, 43662, 21463, 18564, 24186, 31964, 9421, 2314, 34024, 18926, 36472, 34993, 28465, 10912, 38192, 5390, 17183, 40198, 47717, 38192, 13740, 47717, 40571, 21463, 36316, 11512, 36316, 11512, 40571, 33787, 33787, 31215, 4138, 17183, 34134, 24799, 10912, 31663, 12745, 34993, 24954, 17341, 18926, 34024, 6287, 40571, 31288, 24954, 16965, 31651, 4957, 5194, 45747, 4957, 20794, 45051, 23044, 31215, 7693, 31215, 44375, 36865, 33716, 40571, 8490, 37718, 5114, 4957, 22124, 22124, 37710, 35561, 17758, 41400, 19156, 30696, 31651, 34993, 47977, 23579, 13263, 24799, 48559, 33787, 1559, 38164, 6287, 46886, 26915, 41400, 45603, 5114, 10912, 24799, 4957, 18926, 17758, 33787, 11512, 37710, 47866, 37825, 21463, 5250, 19156, 1559, 11512, 13351, 46886, 2361, 10912, 30776, 2748, 16965, 48559, 11512, 24799, 33065, 31215, 8309, 8571, 46886, 25706, 46842, 21292, 196, 26915, 26348, 45603, 35004, 10912, 40571, 33754, 40198, 30776, 28465, 12919, 8309, 24799, 30353, 24954, 33754, 4962, 24954, 13914, 38444, 37710, 49247, 17183, 16283, 48559, 17553, 4957, 38164, 40198, 46226, 7693, 8309, 9421, 13263, 17224, 33787, 17758, 16965, 8571, 26348, 4724, 21573, 21292, 6532, 49247, 37710, 26629, 34217, 33065, 11512, 33754, 38656, 40198, 36316, 45603, 13263, 48395, 37710, 44234, 37710, 25087, 38656, 4957, 43662, 39657, 12919, 43662, 46842, 36865, 46886, 4957, 19156, 45603, 33754, 46226, 17758, 24954, 2228, 1559, 33754, 37710, 8048, 22362, 38544, 21572, 46616, 40198, 10768, 11512, 10957, 44799, 30353, 33754, 45633, 8736, 39657, 13351, 9421, 33043, 8736, 27690, 18523, 6287, 32293, 4957, 31651, 16965, 43875, 49247, 18523, 37710, 38164, 9124, 46842, 38928, 17630, 20345, 8309, 30353, 37710, 22151, 30827, 34584, 8048, 38928, 38928, 47087, 33787, 31215, 49247, 46886, 1090, 38928, 18926, 24799, 6489, 1158, 8571, 40571, 11266, 2120, 17835, 8048, 9421, 33787, 9598, 28849, 37710, 40002, 38444, 38928, 45603, 5194, 21292, 44560, 33754, 44799, 40571, 8571, 30776, 30776, 41400, 4724, 43662, 22151, 30353, 19894, 28465, 13740, 21292, 11759, 7693, 6184, 32293, 45504, 39947, 6184, 5031, 8048, 36865, 13431, 13263, 30776, 22124, 24954, 16283, 12576, 48523, 30776, 30827, 12427, 49247, 19706, 45603, 46061, 31651, 12576, 8048, 22151, 48559, 38928, 30827, 13575, 2361, 47977, 33754, 19706, 32403, 38928, 14917, 22151, 39947, 46061, 47087, 15261, 47087, 4957, 18523, 30949, 29077, 7693, 31651, 5212, 11512, 26348, 7559, 33787, 16696, 38928, 49247, 26348, 31651, 46149, 21292, 18908, 11759, 10957, 38928, 47977, 45603, 42110, 40709, 13431, 38928, 20794, 33787, 15261, 18523, 35042, 17341, 31964, 29941, 13263, 16965, 25197, 38928, 37710, 11925, 13780, 6184, 43662, 4957, 13575, 8571, 39812, 11759, 40571, 9421, 31651, 43662, 8571, 33787, 11759, 38928, 8571, 38768, 19894, 37710, 36316, 28849, 25005, 35914, 8571, 48559, 8571, 42585, 7559, 6184, 35470, 35628, 35561, 13263, 8048, 46802, 28934, 36865, 42460, 14917, 5550, 14917, 38928, 6184, 12419, 20082, 30776, 36865, 43768, 5959, 24799, 38928, 37710, 48559, 31964, 44560, 13575, 20794, 16283, 47866, 196, 25659, 31964, 4724, 28465, 26620, 43662, 8736, 38928, 37710, 46149, 19894, 10473, 16283, 38928, 24082, 31651, 13575, 14870, 22124, 21292, 41400, 40571, 8309, 30827, 16254, 32478, 40709, 46842, 8048, 37710, 43154, 6184, 4957, 10305, 7751, 36865]
    }
  },
  computed: {
    ...mapState(['user'])
  },
  methods: {
    handleRemove(val) {
      var index = this.selectList.indexOf(val)
      this.selectList.splice(index, 1)
      index = this.checkList.indexOf(val)
      this.checkList.splice(index, 1)
    },
    handleSelect(obj) {
      if (this.checkList.indexOf(obj.value) < 0) {
        this.selectList.push(obj)
        this.checkList.push(obj.value)
      }
      this.currentText = ''
    },
    getRecommend() {
      var self = this
      self.recList = []
      // axios.post('http://35.202.6.239/api/v1.0/post_recommendation/', {
      var param = {
        itemId: self.checkList,
        group: self.groupId
      }
      console.log(param)
      axios.post('https://developers.tencent.co.th/api/v1.0/post_recommendation/', param)
        .then(function (response) {
          console.log(response)
          var answerList = response.data.recommend_itemId
          self.recList = answerList.filter(function (item, pos) {
            return answerList.indexOf(item) == pos
          })
          if (self.recList.length > 3) {
            self.recList.length -= (self.recList.length - 3)
          }
        })
        .catch(function (error) {
          console.log(error)
        })
    }
  },
  created() {
  },
  mounted() {
    var self = this
    this.$firebase.database().ref('shops/recognize').limitToLast(1).on('value', function (snapshot) {
      var lastVal = {}
      snapshot.forEach(child => {
        var val = child.val()
        self.customerList.push(val)
        lastVal = val
      })
      if (lastVal.face[0].faceAttributes.gender === 'male') {
        if (lastVal.face[0].faceAttributes.age < 25) {
          self.groupId = 'M18-24'
        } else if (lastVal.face[0].faceAttributes.age < 35) {
          self.groupId = 'M25-34'
        } else if (lastVal.face[0].faceAttributes.age < 45) {
          self.groupId = 'M35-44'
        } else {
          self.groupId = 'M45+'
        }
      } else {
        if (lastVal.face[0].faceAttributes.age < 25) {
          self.groupId = 'F18-24'
        } else if (lastVal.face[0].faceAttributes.age < 35) {
          self.groupId = 'F25-34'
        } else if (lastVal.face[0].faceAttributes.age < 45) {
          self.groupId = 'F35-44'
        } else {
          self.groupId = 'F45+'
        }
      }
      self.recLabel = 'Recommend for ' + lastVal.face[0].faceAttributes.gender + ' (' + lastVal.face[0].faceAttributes.age + ')'
      self.customerList2 = self.customerList.reverse()
    })

    self.dataSource = []
    var i = 0;
    for (var i = 0; i < self.allowList.length; i++) {
      self.dataSource.push({
        value: self.allowList[i].toString(),
        text: products[self.allowList[i]]
      })
    }
    /*
    for (var prop in products) {
      if (i < 1000) {
        self.dataSource.push({
          value: prop,
          text: products[prop]
        })
      } else {
        break
      }
      i++
    }
    */
    // console.log(self.dataSource)
  }
}
</script>

<style scoped>
.demo-chip-container {
  display: flex;
  flex-wrap: wrap;
}
.demo-chip {
  margin: 4px;
}
.thumb {
  width: 120px;
}
.thumb img {
  width: 120px;
}
.ttable td {
  padding: 1em;
}
</style>
